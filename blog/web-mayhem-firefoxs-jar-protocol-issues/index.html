<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Web Mayhem Firefox's JAR Protocol issues</title><meta name="description" content="One of the things that we enjoy the most, here at GNUCITIZEN, is finding issues in features. Unlike bugs, insecure features tend to be more severe and usually last longer due to uneasy and rather long decision making process on whether the feature should be continued or discontinued once and for all. In my previous post I outlined some of my concerns about the `data:` protocol. Today, I would like to draw your attention on the insecurities that come with my personal favorite: `jar:`."><meta property="name" content="Web Mayhem Firefox's JAR Protocol issues"><meta itemprop="name" content="Web Mayhem Firefox's JAR Protocol issues"><meta property="description" content="One of the things that we enjoy the most, here at GNUCITIZEN, is finding issues in features. Unlike bugs, insecure features tend to be more severe and usually last longer due to uneasy and rather long decision making process on whether the feature should be continued or discontinued once and for all. In my previous post I outlined some of my concerns about the `data:` protocol. Today, I would like to draw your attention on the insecurities that come with my personal favorite: `jar:`."><meta itemprop="description" content="One of the things that we enjoy the most, here at GNUCITIZEN, is finding issues in features. Unlike bugs, insecure features tend to be more severe and usually last longer due to uneasy and rather long decision making process on whether the feature should be continued or discontinued once and for all. In my previous post I outlined some of my concerns about the `data:` protocol. Today, I would like to draw your attention on the insecurities that come with my personal favorite: `jar:`."><meta property="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fweb-mayhem-firefoxs-jar-protocol-issues%2F?w=1024"><meta itemprop="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fweb-mayhem-firefoxs-jar-protocol-issues%2F?w=1024"><meta property="og:type" content="website"><meta property="og:url" content="https://www.gnucitizen.org/blog/web-mayhem-firefoxs-jar-protocol-issues/"><meta property="og:title" content="Web Mayhem Firefox's JAR Protocol issues"><meta property="og:description" content="One of the things that we enjoy the most, here at GNUCITIZEN, is finding issues in features. Unlike bugs, insecure features tend to be more severe and usually last longer due to uneasy and rather long decision making process on whether the feature should be continued or discontinued once and for all. In my previous post I outlined some of my concerns about the `data:` protocol. Today, I would like to draw your attention on the insecurities that come with my personal favorite: `jar:`."><meta property="og:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fweb-mayhem-firefoxs-jar-protocol-issues%2F?w=1024"><meta name="twitter:title" content="Web Mayhem Firefox's JAR Protocol issues"><meta name="twitter:description" content="One of the things that we enjoy the most, here at GNUCITIZEN, is finding issues in features. Unlike bugs, insecure features tend to be more severe and usually last longer due to uneasy and rather long decision making process on whether the feature should be continued or discontinued once and for all. In my previous post I outlined some of my concerns about the `data:` protocol. Today, I would like to draw your attention on the insecurities that come with my personal favorite: `jar:`."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fweb-mayhem-firefoxs-jar-protocol-issues%2F?w=1024"><link type="text/css" href="/blog.css" rel="stylesheet"><script type="text/javascript" src="/blog.js"></script></head><body><header id="header"><h1><a href="/"></a></h1><p></p></header><nav id="topnav"><ul><li><a href="/">Home</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/files">Files</a></li><li><a href="/about.html">About</a></li></ul></nav><article><div id="content"><h1 class="title">Web Mayhem Firefox's JAR Protocol issues</h1><div class="date">Wed, 07 Nov 2007 00:51:46 GMT</div><div class="author">by pdp</div><div id="post-content"><p>One of the things that we enjoy the most, here at GNUCITIZEN, is finding issues in features. Unlike bugs, insecure features tend to be more severe and usually last longer due to uneasy and rather long decision making process on whether the feature should be continued or discontinued once and for all. In my previous post I <a href="/blog/bugs-in-the-browser-firefoxs-data-url-scheme-vulnerability">outlined</a> some of my concerns about the <code>data:</code> protocol. Today, I would like to draw your attention on the insecurities that come with my personal favorite: <code>jar:</code>.</p>
<p>For those of you who have never heard of <code>jar:</code>, the protocol is nothing more but a mechanism for pulling content from compressed files. In its most basic usage form, the <code>jar:</code> protocol looks like this:</p>
<pre><code>jar:**[url to archive]**!**[path to file]**

Notice that the protocol embeds another URL in its body. This URL points to the location of the JAR(ZIP) archive from where the **[path to file]** will be read. The secondary URL can be of any kind, including but not only: chrome, file, ftp, https and even data (we will come back to this one latter). The **[path to file]** parameter usually starts with slash (/). This part of the URL specifies the relative path from the JAR root. In case we have a single file called `a.jpg` within the folder `Pictures`, the path will look like this: `/Pictures/a.jpg`. The full URL path may look like the following:

jar:**https://domain.com/path/to/jar.jar**!**/Pictures/a.jpg**</code></pre><p>If you want to learn more about the <code>jar:</code> protocol just look it up on the web. One thing that is very important to stress, and which we are going to use as a basis for the rest of this post, is that <code>jar:</code> content run within the scope/origin of the secondary URL. Therefore, a URL like this: <code>jar:https://example.com/test.jar!/t.htm</code>, will render a page which executes within the origin of <code>https://example.com</code>. It is very important to remember that.</p>
<p>&quot;What does this all mean?&quot; In simple terms, it means that any application which allows upload of JAR/ZIP files is potentially vulnerable to a persistent Cross-site Scripting. Potential targets for this attack include applications such as web mail clients, collaboration systems, document sharing systems, almost everything that smells like Web2.0, etc, etc, etc. Document formats are in particular very vulnerable. The OpenOffice file format (<code>odt</code>) and the less known Microsoft Office 2007 Open Document Format are both based on ZIP. If you create a simple document via either of these products and then you change the extension to <code>.zip</code>, you will be able to read all the files the document is made of. An attacker can simply add a malicious page, with a nasty client-side exploits, inside the archive and change back the extension to <code>.odt</code> or <code>.doc</code>. Who would have though that?</p>
<blockquote>
<p>Once the malicious <code>Zip/Doc/Odt/Etc/Etc/Etc</code> file is uploaded/shared the attacker will be able to cross-script the origins in whatever way he likes. My research led to the discovery of many applications that are affected by this issue including some coming from top software vendors such as Google and Microsoft. Their number is so big that it makes almost no sense to try to list them all here or even be bothered to individually investigate all of the related issues in detail. The root cause is only one: the <code>jar:</code> URL protocol handler.</p>
</blockquote>
<p>But this is not all! Jar URLs can be used to obfuscate malicious payloads to an extend which no Anti-virus software can recognize. The protocol handler can be nested (jars within jars within jars) and can encapsulate the <code>data:</code> protocol as well. Attackers can easily write a self extracting payload which is hidden behind multiple permutations of the both <code>jar:</code> and <code>data:</code> protocols and as such evade intrusion detection and prevention mechanisms that might be on place to guard the perimeter.</p>
<h3 id="what-shall-we-do-to-protect-ourselves-">What shall we do to protect ourselves?</h3>
<p>I haven&#39;t thought well on this yet but the best way is to very carefully sanitize the types of files you allow your users to upload/share. Unfortunately, sometimes this is impossible, especially when it comes to formats such as <code>.odt</code> and <code>.doc</code>. You need to open these files and re-save them and as such to guarantee that there are no malicious leftovers. IDS, IPS and Ant-virus vendors should really start looking into how the <code>jar:</code> protocol works and come up with dynamic mechanism for uncompressing deeply nested URLs.</p>
</div><div id="post-comments"><p><em>Archived Comments</em></p><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/2f6303f9095f59c14c3097ef4df566f5?s=256&amp;d=retro" alt="kuza55"><span class="post-comment-author">kuza55</span><div class="post-comment-content">Nice find pdp!

This could probably also be used to avoid protocol blacklists which blacklits data: URIs as well to avoid XSS filters, and not just IDS'.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/cfdf261e761cbfc46f2484abfc3218fa?s=256&amp;d=retro" alt="severity"><span class="post-comment-author">severity</span><div class="post-comment-content">I get document.domain = null with: jar:http&#58;//example.com/1.zip!/1.html</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/189ea272538720c3222cc9b2aae1a6cc?s=256&amp;d=retro" alt="Gustavo Bittencourt"><span class="post-comment-author">Gustavo Bittencourt</span><div class="post-comment-content">The bug 369814 became public after your disclosure.

https://bugzilla.mozilla.org/show_bug.cgi?id=369814</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/d025d43c89ca5da6b20fb27fdf6b73e9?s=256&amp;d=retro" alt="rado"><span class="post-comment-author">rado</span><div class="post-comment-content">it doesn't work on Opera</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content"><div class="message">I would like to stress one more time that any file that is derivative of ZIP can be used as an attack vector. Moreover, if an archive contains dynamic content such as Flash or HTML, which are vulnerable to attacks, attackers will be able to use them for their benefit.</div></div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/82e83802592a7461af6aedf1a7d991fc?s=256&amp;d=retro" alt="firefox"><span class="post-comment-author">firefox</span><div class="post-comment-content">wonderful,i like this blog</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/b33219b8c01e7bf5e352d614e26916cb?s=256&amp;d=retro" alt="Wisec"><span class="post-comment-author">Wisec</span><div class="post-comment-content">Nice find Pdp! Even if you discovered it independently, in Bugzilla.Mozilla.org, the developers found this issue on Fabruary 2007 (with a p0c too)! I think it's unbelievable that such high impact issues take so much time to fix!!

Just a suggestion to Moz-Devs: 
At least as a quick and dirty fix, add in about:config a flag option which prevents remote site to use data: and jar: and chrome: and whatever. One option for each proprietary/odd uri scheme.

oh, standards answers like "use noscript" will be redirected to /dev/null.

Again kudos to Pdp :)</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/290e868e00e8429bf1624a461b8ef81e?s=256&amp;d=retro" alt="Giorgio Maone"><span class="post-comment-author">Giorgio Maone</span><div class="post-comment-content">Hi pdp,

Latest NoScript development build took a quite drastic but reasonable (considering the behavior of other browsers) measure about JARs.
JAR resources can still be loaded as images, applet classes and the like, but they cannot be loaded as documents.

http://noscript.net/getit#devel</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">good news as always! :) 10x Giorgio.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/870419564f7ebe6cb4f631e98e14e5dd?s=256&amp;d=retro" alt="G-Brain"><span class="post-comment-author">G-Brain</span><div class="post-comment-content">Very, very nice. Another place to use this kind of thing would be a forum that allows attachments.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c2cb44abc9ad1c998cfe344160f76b21?s=256&amp;d=retro" alt="Sam St-Pettersen"><span class="post-comment-author">Sam St-Pettersen</span><div class="post-comment-content">Maybe a local file restriction would be sensible. From my understanding, the only (justified) legitimate use for jar: is in Firefox extensions or XULRunner applications.

Allowing their use in an online context can probably be avoided without any real backlash. Of course, I might be wrong. But I've only seen jar: used legitimately for the aforementioned purposes.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c2cb44abc9ad1c998cfe344160f76b21?s=256&amp;d=retro" alt="Sam St-Pettersen"><span class="post-comment-author">Sam St-Pettersen</span><div class="post-comment-content">BTW Is that a photograph of a young(er) Brenden Eich? :)</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">heh, I don't know but it would be funny if it is :)</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/20d78c987cda1fec614e63ce857aa44d?s=256&amp;d=retro" alt="Kibitz"><span class="post-comment-author">Kibitz</span><div class="post-comment-content">Regarding the nested jars within jars within jars that could contain a virus or other payload: what about A/V that scans at runtime? There are still lots of other considerations to be made, but this may be one small consolation to the huge list of issues that this discovery makes.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/89886495b27cfdc78593e1f5c8810594?s=256&amp;d=retro" alt=".mario"><span class="post-comment-author">.mario</span><div class="post-comment-content">Reading the mozilla.org bug lists is like a Saturday noon shopping session ;) 

Anyway - as a developer you must _never_ trust user input especially when coming to uploads.

1. Check MIME Type
2. Check image size
3. Check for HTML/PHP like patterns in the images source (http://phpfi.com/274478)
4. Transform the image (other size AND other format) 
5. Finally place the image in the upload folder

Greetings,
.mario</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">.mario yes, but I would like to stress one more time: any file can be used to carry the attack. Even TXT file can do the job. So for example, let's say that your application allows export of documents as TXT files. This is a potential problem.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/8646bd4e904762c599e11665cc67f158?s=256&amp;d=retro" alt="Kishor"><span class="post-comment-author">Kishor</span><div class="post-comment-content">Nice! as always..</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/513bd234e89071690de6ddad6c11cbab?s=256&amp;d=retro" alt="beford"><span class="post-comment-author">beford</span><div class="post-comment-content">pdp, this can also be abused if the site has an open redirect issue, I've posted a simple poc on my site. This makes the amount of 'now' vulnerable sites bigger :)</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">beford, I wrote a new post just for you :) very nice find!</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/caaefeae15811188de49e613614c32ff?s=256&amp;d=retro" alt="Peter da Silva"><span class="post-comment-author">Peter da Silva</span><div class="post-comment-content">I see a few other issues here.

First, there's a problem in the basic design of the handler. Conceptually, the file is not accessed through a "jar:" protocol, the fact that the file can contain content is an attribute of the file. It's the MIME type of the file that should result in the file being treated as a JAR file:

http&#58;//example.com/path/to/file.jar#/path/inside/jar/file.html...

This would have avoided this problem right from the start.

Second, allowing arbitrary access to the contents of untrusted archives in any context is dangerous. Apple's been burned by this, Microsoft's been burned by this. What is the benefit of this handler that makes the risk worthwhile?

Third: assuming this is allowed, the file should be treated as part of the directory tree of the hosting site. If it's redirected, that's the site in the redirect, not the site in the original URL. Are there other situations in Firefox where the original URL rather than the redirected URL are used for this purpose?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/943a78f7f3deac36033688f95c4a889e?s=256&amp;d=retro" alt="opera11"><span class="post-comment-author">opera11</span><div class="post-comment-content">It is interesting issue :) Good, that i dont use FF :)))</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/b6202ccdf0d30afd1d3eff7e9270b455?s=256&amp;d=retro" alt="sanjuro"><span class="post-comment-author">sanjuro</span><div class="post-comment-content">Never heard of that "jar:" protocol. I wonder if this issue has been fixed by Google, Microsoft and everyone else since this post.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/344c9a2663aaab035315b8dac9277901?s=256&amp;d=retro" alt="corrector"><span class="post-comment-author">corrector</span><div class="post-comment-content">"Never heard of that â€œjar:â€ protocol. I wonder if this issue has been fixed by Google, Microsoft and everyone else since this post." Hug? What is this nonsense all about? There is not/was not, "a Google, MS and every one else" bug. There is (was) an awful, ridiculous, crazy, MS-sh*tware-style exploit-invitation-by-design FF obscenity. No one needs to fix anything except Mozilla. Someone needs to be fired, and that someone is actually so many people. FF credibility is ruined *forever* (or until this team is fired for good).</div></div></div></div></article><footer id="footer"><p>Copyright &copy; 2020 <a href=""></a>. All rights reserved.</p></footer></body></html>