<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Python SSL Mitm Proxy and More</title><meta name="description" content="Lately I've been busy with putting together a python module which allows me to create man-in-the-middle (MITM) HTTP Proxies with a programmer-friendly extension interface and support for SSL. This kind of proxies can be used for many things ranging from creating your own tampering proxies to hijacking network traffic via a transparent proxy connection."><meta property="name" content="Python SSL Mitm Proxy and More"><meta itemprop="name" content="Python SSL Mitm Proxy and More"><meta property="description" content="Lately I've been busy with putting together a python module which allows me to create man-in-the-middle (MITM) HTTP Proxies with a programmer-friendly extension interface and support for SSL. This kind of proxies can be used for many things ranging from creating your own tampering proxies to hijacking network traffic via a transparent proxy connection."><meta itemprop="description" content="Lately I've been busy with putting together a python module which allows me to create man-in-the-middle (MITM) HTTP Proxies with a programmer-friendly extension interface and support for SSL. This kind of proxies can be used for many things ranging from creating your own tampering proxies to hijacking network traffic via a transparent proxy connection."><meta property="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fpython-ssl-mitm-proxy-and-more%2F?w=1024"><meta itemprop="image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fpython-ssl-mitm-proxy-and-more%2F?w=1024"><meta property="og:type" content="website"><meta property="og:url" content="https://www.gnucitizen.org/blog/python-ssl-mitm-proxy-and-more/"><meta property="og:title" content="Python SSL Mitm Proxy and More"><meta property="og:description" content="Lately I've been busy with putting together a python module which allows me to create man-in-the-middle (MITM) HTTP Proxies with a programmer-friendly extension interface and support for SSL. This kind of proxies can be used for many things ranging from creating your own tampering proxies to hijacking network traffic via a transparent proxy connection."><meta property="og:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fpython-ssl-mitm-proxy-and-more%2F?w=1024"><meta name="twitter:title" content="Python SSL Mitm Proxy and More"><meta name="twitter:description" content="Lately I've been busy with putting together a python module which allows me to create man-in-the-middle (MITM) HTTP Proxies with a programmer-friendly extension interface and support for SSL. This kind of proxies can be used for many things ranging from creating your own tampering proxies to hijacking network traffic via a transparent proxy connection."><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://s.wordpress.com/mshots/v1/https%3A%2F%2Fwww.gnucitizen.org%2Fblog%2Fpython-ssl-mitm-proxy-and-more%2F?w=1024"><link type="text/css" href="/blog.css" rel="stylesheet"><script type="text/javascript" src="/blog.js"></script></head><body><header id="header"></header><nav id="topnav"><ul><li><a href="/">Home</a></li><li><a href="/projects.html">Projects</a></li><li><a href="/files">Files</a></li><li><a href="/about.html">About</a></li></ul></nav><article><div id="content"><h1 class="title">Python SSL Mitm Proxy and More</h1><div class="date">Sat, 14 Feb 2009 17:54:19 GMT</div><div class="author">by
<a href="/members/pdp.html">pdp</a></div><div id="post-content"><p>Lately I&#39;ve been busy with putting together a python module which allows me to create man-in-the-middle (MITM) HTTP Proxies with a programmer-friendly extension interface and support for SSL. This kind of proxies can be used for many things ranging from creating your own tampering proxies to hijacking network traffic via a transparent proxy connection.</p>
<pre><code>[/files/2009/02/httpservers.py](/files/2009/02/httpservers.py)</code></pre><p>I am quite pleased with the end result! Although my proxy hasn&#39;t been heavily tested, I find the code lot better when compared to Dave Aitel&#39;s SpikeProxy (sorry Dave :)) and extending/adding functionalities is actually piece of cake.</p>
<p>I need to mention that the code is heavily inspired by various source codes found on the Internet via Google. Actually all SSL MITM Proxy code for python available today are absolute crap. Codez are either broken or you need to be a rocket scientist in order to understand them. Nevertheless, these sources proved to be quite helpful when I was stuck. And I was stuck many times.</p>
<p>My module also contains stubs for creating all kinds of HTTP servers. It follows a simple design pattern introduced by Python&#39;s built-in <code>SocketServer</code>, therefore the code is very pythonic. I need to mention that I used monkey patching only once and it can be removed as it is unimportant. So overall, the module should be pretty clean although there is a room for improvement.</p>
<p>Have a look at the code and if you can contribute with fixes and improvements that will be great. Just let me know.</p>
</div><div id="post-comments"><p><em>Archived Comments</em></p><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/f13074b7e97c68d30a5792d4829dc5ef?s=256&amp;d=retro" alt="Mike"><span class="post-comment-author">Mike</span><div class="post-comment-content">Nice tool. I have a couple of corrections. I would have emailed them, but I couldn't find your email. Now you have mine though so we should get in contact.

Line 488: <code>SSL.SysCallError</code> should be <code>OpenSSL.SSL.SysCallError</code>

I was getting a <code>SysCallError</code> exception on reads, so I added "or OpenSSL.SSL.SysCallError" to line 276.

The <code>do_GET</code> function on line 161 was having problems with certain web sites. I think it has something to do with the <code>if hasattr(self.server, 'chainedHandler")</code> block from the other <code>do_GET</code> function elsewhere in the code. When I copied that code from the other do_GET to the do_GET on line 161 it worked for every site I tried it on.

Email me so I know how to get a hold of you later if I find more bugs, ok?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">Hi Mike,

Thanks for letting me know. It will be great if we can polish this module as much as possible as I see that there is a lot of interest in a technology like this one and no one is providing it at the moment. I personally need it for several projects of mine.

Regarding your comment on HTTPServerWrapper class. This code is essential in order to make SSL sniffing work. It basically transmits information about the path which needs to be accessed from the SSL endpoint the browser tries to connect to via the proxy. Anyway, I will email you so we can keep in touch.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/6ab7b730173f71ae8c931a52abd48b62?s=256&amp;d=retro" alt="Anonymous"><span class="post-comment-author">Anonymous</span><div class="post-comment-content">Good stuff.

If i wanted to write some basic tests for this, how would I go about doing it? I think it'd be useful. I was thinking something along the lines of, say, having a Paramiko-driven app try and connect to https&#58;//gmail.com using some dummy username and password we create, and seeing if it can intercept the information properly (?)

Just a thought. I don't have enough netsec experience to contribute directly, but i do have python experience enough (and with scripting paramiko) to do this i think. At the  very least, setting up some unit tests should help me figure out how the python networkign stuff works better.

Again, good stuff! I'll be keeping tabs on this definitely.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">The file is self-descriptive. It will be great if someone can spend some time cleaning up the code an also to make sure that everything works ok.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/22fdafb741a77191445b50c828eddee5?s=256&amp;d=retro" alt="schang"><span class="post-comment-author">schang</span><div class="post-comment-content">Mike,

could you share the fixed code with us ?
I have been trying to fix it myself. It kind of works but it always takes like 1 or 2 minutes before I get an answer to my POST...

thanks</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">schang, I have been a bit busy lately but I do have some patches that needs to be merged and I will do so as soon as I get some free time.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/cd97fb54db7afec67a70e2cfebc1ec02?s=256&amp;d=retro" alt="Eric Blair"><span class="post-comment-author">Eric Blair</span><div class="post-comment-content">I don't use Python, but clicked to see "SSL Mitm Proxy."

It might be easier to write this as a general (CGI) script that could be developed on your local box without a web server. I could script it using a Bourne shell script ;-) but I would probably use my favorite, Tcl.

From the command-line, you can use "openssl s_client", and s_server and generate a certificate:

http://www.securityfocus.com/infocus/1486
http://www.vanemery.com/Linux/Apache/openSSL.html

Anyway, I put up a page regarding SSL termination:

http://grandscheme.org/gs.cgi?How-secure-is-https.html

Since a browser will complain about certificate mismatches, I was wondering how you were expecting your code to be useful as part of a "transparent SSL proxy." You made no mention of certificates.</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">good stuff. the reason I wrote this proxy is to create a new HTTP tampering tool which I am comfortable with. but yes, you can use the code for MITM attacks but you have to make a couple of changes. I think that recently there was a presentation which discussed MITM-like attacks for SSL. worth googling it!</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/a9d773561c7bb7591e04b2ce00c0e46f?s=256&amp;d=retro" alt="Christian Martorella"><span class="post-comment-author">Christian Martorella</span><div class="post-comment-content">Hi pdp, we created a proxy https in python, for our tool ProxyStrike, you can check it here: http://www.edge-security.com/proxystrike.php

We faced the same problem as you, at time we wrote the tool the only available proxy in http was the one in spikeProxy.

By the way we updated the tool and now you can easily implement plugins.

-CMM</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">cool, thanks! is this tool written in python as well?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/20d19d3f61b879780435b111db84a1e2?s=256&amp;d=retro" alt="eduardo"><span class="post-comment-author">eduardo</span><div class="post-comment-content">Hi, I would like to try your mitm proxy for ssl, but i have not been able to make it work with windows, could you help me provide a step by step?  feel free to contact me by email

thanks</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/9314a4344d2f04e6d5af3ac48c49abdd?s=256&amp;d=retro" alt="darb"><span class="post-comment-author">darb</span><div class="post-comment-content">Any chance of using this to effectively block Skype's use of https, while allowing the rest of https traffic alone?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/18404cfb0114ef1150b7f1b5892510f2?s=256&amp;d=retro" alt="Subbu"><span class="post-comment-author">Subbu</span><div class="post-comment-content">I'm seeing a bug in this proxy, I will investigate a fix,  but wanted to let you know. The issue is this:

I clear all the cookies in a browser. Then
I fire up the proxy and browse some websites, and then look at what cookies are set in my browser, I don't see some cookies that I expect to be set. 

When I do the exact same thing (clear cookies, _ exact websites), I can see the cookies being set in the browser. 

So my inference is that the proxy is somehow eating up the cookies in the response. These sites are http, not https, so that is also not the issue. 

Any pointers for investigation?</div></div><div class="post-comment"><img class="post-comment-avatar" src="//gravatar.com/avatar/c4db4e65c9f09f2a373fcaefa5e2bfb4?s=256&amp;d=retro" alt="pdp"><span class="post-comment-author">pdp</span><div class="post-comment-content">darb, not sure! you have to check.</div></div></div></div></article><footer id="footer"><p>Copyright &copy; 2022 <a href=""></a>. All rights reserved.</p></footer></body></html>